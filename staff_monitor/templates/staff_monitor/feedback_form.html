<!-- staff_monitor/templates/staff_monitor/feedback_form.html -->
{% extends 'staff_monitor/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<div class="container-fluid">
    <!-- Header Section -->
    <div class="card mb-4 form-card main-card">
        <div class="card-header bg-danger text-white py-3">
            <h2 class="text-center mb-0">MARIAMPUR HOSPITAL</h2>
            <h4 class="text-center mb-0">
                {% if department_head %}
                DEPARTMENT HEAD INCIDENT REPORT FORM
                {% else %}
                STAFF INCIDENT REPORT FORM
                {% endif %}
            </h4>
        </div>
        
        <div class="card-body p-4">
            <form method="post" class="needs-validation" novalidate id="incidentForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Staff Information Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-user-tie me-2 text-danger"></i>
                            <span>{% if department_head %}Department Head{% else %}Staff{% endif %} Information</span>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <table class="table table-bordered table-responsive">
                                    <tr>
                                        <th class="bg-light" width="40%">Name:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.user.get_full_name }}
                                            {% elif department_head %}
                                                {{ department_head.user.get_full_name }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Designation:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.position }}
                                            {% elif department_head %}
                                                {{ department_head.designation }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Employee ID:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.employee_id }}
                                            {% elif department_head %}
                                                DH-{{ department_head.id }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-lg-6">
                                <table class="table table-bordered table-responsive">
                                    <tr>
                                        <th class="bg-light" width="40%">Department:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.department }}
                                            {% elif department_head %}
                                                {{ department_head.department }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Date of Joining:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.joining_date }}
                                            {% elif department_head %}
                                                {{ department_head.joining_date|default:"Not specified" }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Date of Appointment:</th>
                                        <td>
                                            {% if staff %}
                                                {{ staff.appointment_date|default:"-" }}
                                            {% elif department_head %}
                                                {{ department_head.appointment_date|default:"-" }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Incident Information Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-info-circle me-2 text-danger"></i>
                            <span>Incident Information</span>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6 col-lg-3 mb-3 mb-md-0">
                                <label class="form-label fw-semibold">DATE OF INCIDENT:</label>
                                <input type="date" name="incident_date" id="incident_date" class="form-control form-input" required
                                    max="{{ today|date:'Y-m-d' }}"
                                    value="{{ today|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3 mb-md-0">
                                <label class="form-label fw-semibold">TIME:</label>
                                <input type="time" name="incident_time" class="form-control form-input" required>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3 mb-lg-0">
                                <label class="form-label fw-semibold">LOCATION:</label>
                                <input type="text" name="incident_location" class="form-control form-input" required>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label fw-semibold">INCIDENT REPORT NO.:</label>
                                <input type="text" name="report_number" id="report_number" class="form-control form-input bg-light fw-bold" 
                                    readonly style="border: 2px solid #dc3545; color: #dc3545;">
                                <small class="form-text text-muted">(Auto generated unique identifier)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nature of Incident Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                            <span>Nature of incident</span>
                        </div>

                        <!-- Positive nature of incident -->
                        <div class="mb-4">
                            <h5 class="text-success fw-bold mb-3">
                                <i class="fas fa-thumbs-up me-2"></i>Positive nature of incident
                            </h5>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="good_conduct" id="goodConduct">
                                        <label class="form-check-label" for="goodConduct">
                                            Good conduct
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="good_procedure_services" id="goodProcedure">
                                        <label class="form-check-label" for="goodProcedure">
                                            Good procedure / Services
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="good_communication" id="goodCommunication">
                                        <label class="form-check-label" for="goodCommunication">
                                            Good communication
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="efficient_problem_solving" id="efficientProblemSolving">
                                        <label class="form-check-label" for="efficientProblemSolving">
                                            Efficient problem solving
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="good_qualities_observed" id="goodQualities">
                                        <label class="form-check-label" for="goodQualities">
                                            Good qualities observed
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Non compliance/Undesirable nature of incident -->
                        <div>
                            <h5 class="text-danger fw-bold mb-3">
                                <i class="fas fa-thumbs-down me-2"></i>Non compliance/ Undesirable nature of incident
                            </h5>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="negligence" id="negligence">
                                        <label class="form-check-label" for="negligence">
                                            Negligence
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="rude_behavior" id="rudeBehavior">
                                        <label class="form-check-label" for="rudeBehavior">
                                            Rude behavior / Attitude
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="communication_error" id="communicationError">
                                        <label class="form-check-label" for="communicationError">
                                            Communication error / issue
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="documentation_issue" id="documentationIssue">
                                        <label class="form-check-label" for="documentationIssue">
                                            Documentation issue / error
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="reporting_error" id="reportingError">
                                        <label class="form-check-label" for="reportingError">
                                            Reporting error / issue
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="medication_error" id="medicationError">
                                        <label class="form-check-label" for="medicationError">
                                            Medication error
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="assault" id="assault">
                                        <label class="form-check-label" for="assault">
                                            Assault
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="policy_violation" id="policyViolation">
                                        <label class="form-check-label" for="policyViolation">
                                            Policy violation
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="collaborative_work_issue" id="collaborativeWorkIssue">
                                        <label class="form-check-label" for="collaborativeWorkIssue">
                                            Collaborative work issue / Error
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="procedure_failure" id="procedureFailure">
                                        <label class="form-check-label" for="procedureFailure">
                                            Failure to carry out procedure well
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="misconduct" id="misconduct">
                                        <label class="form-check-label" for="misconduct">
                                            Mis conduct
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox mb-2">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="unfavorable_qualities" id="unfavorableQualities">
                                        <label class="form-check-label" for="unfavorableQualities">
                                            Unfavourable/ undesirable qualities observed
                                        </label>
                                    </div>
                                    <div class="form-check custom-checkbox">
                                        <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                            value="other" id="otherIncident">
                                        <label class="form-check-label" for="otherIncident">
                                            Others (Specify)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3 other-incident-details" style="display: none;">
                            <div class="col-md-12">
                                <input type="text" name="other_incident_type" class="form-control form-input" 
                                    placeholder="Please specify the incident type">
                            </div>
                        </div>
                        
                        <!-- New description box for selected incidents -->
                        <div class="row mt-4 incident-description-container" style="display: none;">
                            <div class="col-12">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white py-2">
                                        <h5 class="mb-0 selected-incidents-heading">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Description of Selected Incidents
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">
                                                Selected incidents:
                                            </label>
                                            <div id="selected-incidents-list" class="mb-3"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label fw-semibold">
                                                Please provide a detailed description of the incident(s):
                                            </label>
                                            <textarea name="incident_description" class="form-control" rows="4" 
                                                placeholder="Describe what happened, who was involved, and any relevant details about the selected incident types."></textarea>
                                        </div>
                                        
                                        <!-- Incident Photo Upload/Capture Section -->
                                        <div class="mt-3">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-camera me-1"></i> Photo Evidence (Optional):
                                            </label>
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <input type="file" name="incident_photo" id="incident_photo" class="form-control" 
                                                        accept="image/*">
                                                    <small class="text-muted">Upload a photo related to the incident.</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <button type="button" id="capture-btn" class="btn btn-outline-danger w-100">
                                                        <i class="fas fa-camera me-1"></i> Capture Photo
                                                    </button>
                                                    <!-- Hidden camera input specifically for capture -->
                                                    <input type="file" id="camera_input" accept="image/*" capture="camera" style="display: none;">
                                                </div>
                                            </div>
                                            <div id="photo-preview" class="mt-2 text-center d-none">
                                                <img id="preview-image" class="img-fluid img-thumbnail" style="max-height: 200px;">
                                                <div class="mt-2">
                                                    <button type="button" id="remove-photo" class="btn btn-sm btn-outline-secondary">
                                                        <i class="fas fa-times me-1"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related To Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-link me-2 text-danger"></i>
                            <span>Related to</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-lg-4 mb-3 mb-lg-0">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="colleagues" id="colleagues">
                                    <label class="form-check-label" for="colleagues">
                                        1. Colleagues
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="patients" id="patients">
                                    <label class="form-check-label" for="patients">
                                        2. Patients
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4 mb-3 mb-lg-0">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="attender" id="attender">
                                    <label class="form-check-label" for="attender">
                                        3. Attender
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="doctors" id="doctors">
                                    <label class="form-check-label" for="doctors">
                                        4. Doctors
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="policies" id="policies">
                                    <label class="form-check-label" for="policies">
                                        5. Policies / Procedures
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Individuals Involved Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-users me-2 text-danger"></i>
                                <span>Individuals involved</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger add-individual-btn">
                                <i class="fas fa-plus me-1"></i>Add Individual
                            </button>
                        </div>
                        
                        <div id="individuals-container">
                            <!-- Template row for individuals involved -->
                            <div class="individual-row row mb-3">
                                <div class="col-md-6 col-lg-3 mb-2 mb-lg-0">
                                    <label class="form-label fw-semibold">1. Name of Employee('s)</label>
                                    <input type="text" name="individual_name[]" class="form-control form-input">
                                </div>
                                <div class="col-md-6 col-lg-3 mb-2 mb-lg-0">
                                    <label class="form-label fw-semibold">2. Department</label>
                                    <input type="text" name="individual_department[]" class="form-control form-input">
                                </div>
                                <div class="col-md-6 col-lg-3 mb-2 mb-lg-0">
                                    <label class="form-label fw-semibold">3. Position of Employee</label>
                                    <input type="text" name="individual_position[]" class="form-control form-input">
                                </div>
                                <div class="col-md-5 col-lg-2 mb-2 mb-lg-0">
                                    <label class="form-label fw-semibold">4. Role in Incident</label>
                                    <input type="text" name="individual_role[]" class="form-control form-input">
                                </div>
                                <div class="col-md-1 col-lg-1 d-flex align-items-end mb-2 mb-lg-0">
                                    <label class="form-label text-white d-none d-md-block">Remove</label>
                                    <button type="button" class="btn btn-outline-secondary remove-individual-btn" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Taken Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-tasks me-2 text-danger"></i>
                            <span>Action taken</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2 mb-md-0">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input action-taken" type="checkbox" name="action_type" 
                                        value="immediate_action" id="immediateAction">
                                    <label class="form-check-label" for="immediateAction">
                                        1. Immediate action taken
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input action-taken" type="checkbox" name="action_type" 
                                        value="follow_up_action" id="followUpAction">
                                    <label class="form-check-label" for="followUpAction">
                                        2. Follow-up Action Taken
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conditional fields that appear when specific actions are selected -->
                        <div class="row mt-3 immediate-action-details action-detail-box" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <textarea name="immediate_action_details" class="form-control form-input" rows="3" 
                                        placeholder="Describe immediate action taken"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mt-3 follow-up-action-details action-detail-box" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <textarea name="follow_up_action_details" class="form-control form-input" rows="3" 
                                        placeholder="Describe follow-up action taken"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Preparer Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-user-edit me-2 text-danger"></i>
                            <span>Report Preparation</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Report Prepared by:</label>
                                <input type="text" name="prepared_by" class="form-control form-input bg-light" 
                                    value="{{ request.user.get_full_name }}" readonly>
                                <small class="text-muted d-block mt-1">Auto-populated with your name</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Position/Role:</label>
                                <input type="text" name="reporter_position" class="form-control form-input bg-light" 
                                    value="{% if request.user.is_staff %}HR Director{% else %}{% if department_head %}Department Head - {{ department_head.department.name }}{% else %}{{ staff.position }}{% endif %}{% endif %}" readonly>
                                <small class="text-muted d-block mt-1">Auto-populated with your role in the organization</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex flex-column flex-md-row justify-content-end gap-2">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg mb-2 mb-md-0">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="fas fa-save me-2"></i>Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.card-header {
    background-color: #dc3545 !important;
}

.main-card {
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.form-section-card {
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}

.form-section-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.form-input {
    border-radius: 0.5rem;
    border: 1px solid #ced4da;
    padding: 0.625rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

.form-check-input:checked {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
}

.btn-outline-secondary {
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    transform: translateY(-2px);
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
    transition: all 0.3s ease;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
    transform: translateY(-1px);
}

.fw-bold {
    font-weight: bold;
}

.fw-semibold {
    font-weight: 600;
}

.action-detail-box {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.5rem;
    border-left: 3px solid #dc3545;
}

.custom-checkbox .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.15rem;
}

.custom-checkbox .form-check-label {
    padding-left: 0.25rem;
}

.table-bordered th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.table-bordered td, .table-bordered th {
    padding: 0.75rem;
}

.individual-row {
    animation: fadeIn 0.3s ease-in-out;
    position: relative;
    padding: 0.75rem;
    border-radius: 0.5rem;
}

.individual-row:not(:last-child) {
    border-bottom: 1px dashed #dee2e6;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
}

.individual-row:nth-child(even) {
    background-color: rgba(0,0,0,0.01);
}

.remove-individual-btn {
    border-radius: 50%;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-individual-btn {
    border-radius: 0.5rem;
    font-weight: 500;
}

/* Styles for incident description section */
.incident-description-container {
    animation: fadeIn 0.3s ease-in-out;
}

.selected-incidents-heading {
    font-size: 1.1rem;
}

#selected-incidents-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

#selected-incidents-list .badge {
    font-size: 0.9rem;
    font-weight: 500;
    border-radius: 0.4rem;
}

textarea[name="incident_description"] {
    resize: vertical;
    min-height: 100px;
    transition: all 0.3s ease;
}

textarea[name="incident_description"]:focus {
    min-height: 150px;
}

/* Responsive styling */
@media (max-width: 767.98px) {
    .container-fluid {
        padding: 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .section-title {
        font-size: 1.1rem;
    }
    
    .form-section-card {
        margin-bottom: 1rem;
    }
    
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .form-input {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    
    .table {
        font-size: 0.9rem;
    }
    
    .table th, .table td {
        padding: 0.5rem;
    }
    
    .individual-row {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
    }
    
    .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-6 {
        margin-bottom: 0.5rem;
    }
    
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 1rem;
    }
    
    #selected-incidents-list .badge {
        font-size: 0.8rem;
    }
}

/* Small mobile devices */
@media (max-width: 575.98px) {
    .card-header {
        padding: 0.75rem;
    }
    
    .card-header h2 {
        font-size: 1.5rem;
    }
    
    .card-header h4 {
        font-size: 1.1rem;
    }
    
    .form-check-label {
        font-size: 0.9rem;
    }
    
    .table th, .table td {
        padding: 0.4rem;
        font-size: 0.8rem;
    }
    
    .table-bordered {
        border: none;
    }
    
    .remove-individual-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .add-individual-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        width: 100%;
        margin-top: 0.5rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 0.5rem;
    }
    
    .d-flex.justify-content-end {
        flex-direction: column;
    }
    
    .d-flex.justify-content-end .btn {
        width: 100%;
    }
    
    .d-flex.justify-content-end .gap-2 {
        gap: 0.5rem !important;
    }
    
    .section-title {
        font-size: 1rem;
    }

    /* Increase checkbox tap target size */
    .form-check {
        padding-left: 1.8rem;
    }
    
    .form-check-input {
        width: 1.2rem;
        height: 1.2rem;
        margin-left: -1.8rem;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the report number on page load
    generateReportNumber();
    
    // Re-generate report number when date changes
    document.getElementById('incident_date').addEventListener('change', generateReportNumber);
    
    // Show/hide other incident type details
    document.getElementById('otherIncident').addEventListener('change', function() {
        const otherIncidentDetails = document.querySelector('.other-incident-details');
        otherIncidentDetails.style.display = this.checked ? 'flex' : 'none';
    });
    
    // Handle incident type checkboxes
    const incidentTypeCheckboxes = document.querySelectorAll('.incident-type');
    const incidentDescriptionContainer = document.querySelector('.incident-description-container');
    const selectedIncidentsList = document.getElementById('selected-incidents-list');
    
    // Function to update incident description section
    function updateIncidentDescriptionSection() {
        // Get all checked incident types
        const checkedIncidents = Array.from(document.querySelectorAll('.incident-type:checked'));
        
        // Show/hide the description container based on selection
        if (checkedIncidents.length > 0) {
            incidentDescriptionContainer.style.display = 'flex';
            incidentDescriptionContainer.style.animation = 'fadeIn 0.3s ease-in-out';
            
            // Clear the selected incidents list
            selectedIncidentsList.innerHTML = '';
            
            // Add each selected incident as a badge
            checkedIncidents.forEach(checkbox => {
                const incidentLabel = checkbox.nextElementSibling.textContent.trim();
                const badge = document.createElement('span');
                badge.className = 'badge bg-danger me-2 mb-2 p-2';
                badge.textContent = incidentLabel;
                selectedIncidentsList.appendChild(badge);
            });
        } else {
            incidentDescriptionContainer.style.display = 'none';
        }
    }
    
    // Add event listeners to all incident type checkboxes
    incidentTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateIncidentDescriptionSection);
    });
    
    // Show/hide immediate action details
    document.getElementById('immediateAction').addEventListener('change', function() {
        const immediateActionDetails = document.querySelector('.immediate-action-details');
        immediateActionDetails.style.display = this.checked ? 'flex' : 'none';
    });
    
    // Show/hide follow-up action details
    document.getElementById('followUpAction').addEventListener('change', function() {
        const followUpActionDetails = document.querySelector('.follow-up-action-details');
        followUpActionDetails.style.display = this.checked ? 'flex' : 'none';
    });

    // Add subtle animation to checkboxes
    const checkboxes = document.querySelectorAll('.form-check-input');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                this.closest('.form-check').classList.add('checkbox-active');
            } else {
                this.closest('.form-check').classList.remove('checkbox-active');
            }
        });
    });
    
    // Individual rows functionality
    const individualsContainer = document.getElementById('individuals-container');
    const addIndividualBtn = document.querySelector('.add-individual-btn');
    
    // Function to add a new individual row
    addIndividualBtn.addEventListener('click', function() {
        const container = document.getElementById('individuals-container');
        const individualRows = container.querySelectorAll('.individual-row');
        
        // Clone the first row
        const newRow = individualRows[0].cloneNode(true);
        
        // Clear input values
        newRow.querySelectorAll('input').forEach(input => {
            input.value = '';
        });
        
        // Enable the remove button
        const removeBtn = newRow.querySelector('.remove-individual-btn');
        removeBtn.disabled = false;
        
        // Add event listener to remove button
        removeBtn.addEventListener('click', function() {
            const individualRows = container.querySelectorAll('.individual-row');
            if (individualRows.length > 1) {
                newRow.remove();
            }
        });
        
        // Append the new row
        container.appendChild(newRow);
        
        // On mobile, scroll to the new row
        if (window.innerWidth < 768) {
            setTimeout(() => {
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    });
    
    // Make checkboxes more touch-friendly on mobile
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        document.querySelectorAll('.form-check-label').forEach(label => {
            label.addEventListener('click', function(e) {
                e.preventDefault();
                const checkbox = document.getElementById(this.getAttribute('for'));
                checkbox.checked = !checkbox.checked;
                
                // Trigger change event for incident type checkboxes
                if (checkbox.classList.contains('incident-type')) {
                    updateIncidentDescriptionSection();
                }
                
                // Trigger change event for action taken checkboxes
                if (checkbox.classList.contains('action-taken')) {
                    const actionType = checkbox.value;
                    toggleActionDetailBox(actionType, checkbox.checked);
                }
            });
        });
    }

    // Form validation and submission
    const form = document.getElementById('incidentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Always prevent default form submission first
            
            // Check required fields
            const requiredInputs = form.querySelectorAll('input[required]');
            let allFilled = true;
            
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    allFilled = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            // Check if at least one incident type is selected
            const incidentTypes = form.querySelectorAll('input[name="incident_type"]:checked');
            if (incidentTypes.length === 0) {
                allFilled = false;
                Swal.fire({
                    title: 'Incomplete Form',
                    text: 'Please select at least one incident type.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            // Check if incident description is filled when incidents are selected
            const incidentDescription = document.querySelector('textarea[name="incident_description"]');
            if (incidentTypes.length > 0 && (!incidentDescription.value || incidentDescription.value.trim() === '')) {
                allFilled = false;
                Swal.fire({
                    title: 'Incomplete Form',
                    text: 'Please provide a description for the selected incident(s).',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });
                incidentDescription.classList.add('is-invalid');
                return;
            } else {
                incidentDescription.classList.remove('is-invalid');
            }

            if (!allFilled) {
                Swal.fire({
                    title: 'Incomplete Form',
                    text: 'Please fill in all required fields before submitting.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            // All validations passed, show confirmation dialog
            Swal.fire({
                title: 'Confirm Submission',
                html: `
                    <div class="text-start">
                        <p>Are you sure you want to submit this incident report for:</p>
                        <p><strong>Staff:</strong> {% if staff %}{{ staff.user.get_full_name }}{% elif department_head %}{{ department_head.user.get_full_name }}{% endif %}</p>
                        <p><strong>Incident Date:</strong> ${document.getElementById('incident_date').value}</p>
                        <p><strong>Report Number:</strong> ${document.getElementById('report_number').value}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Submit',
                cancelButtonText: 'No, Review',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: 'Submitting...',
                        text: 'Please wait while we process your report.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Submit the form
                    form.submit();
                }
            });
        });
    }
    
    // Photo upload and camera capture functionality
    const photoInput = document.getElementById('incident_photo');
    const cameraInput = document.getElementById('camera_input');
    const captureBtn = document.getElementById('capture-btn');
    const previewContainer = document.getElementById('photo-preview');
    const previewImage = document.getElementById('preview-image');
    const removePhotoBtn = document.getElementById('remove-photo');
    
    // Function to handle image preview
    function handleImagePreview(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Check if it's an image
            if (!file.type.match('image.*')) {
                Swal.fire({
                    title: 'Invalid File',
                    text: 'Please select an image file (JPEG, PNG, etc.)',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                input.value = '';
                previewContainer.classList.add('d-none');
                return;
            }
            
            // Display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Handle regular file input change
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            handleImagePreview(this);
        });
    }
    
    // Handle camera input change
    if (cameraInput) {
        cameraInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                // Get the file from camera input
                const file = this.files[0];
                
                // Create a new FileList for the main input
                // This part is tricky because FileList objects are immutable
                // For forms to work, we'll copy the file to the main input
                
                // Create a blob and make a new file to avoid any potential issues
                const blob = new Blob([file], { type: file.type });
                const newFile = new File([blob], file.name || "camera_photo.jpg", { 
                    type: file.type,
                    lastModified: new Date().getTime()
                });
                
                // Create a temporary form
                const tempForm = new FormData();
                tempForm.append('incident_photo', newFile);
                
                // If we can't directly set the files property, at least we have the file in the preview
                handleImagePreview(this);
                
                // Update hidden fields or form data to ensure the image is submitted
                // In some browsers, we can't directly set files property of an input
                // So we create a clone of the input with the right properties
                try {
                    // Create a new file input
                    const newInput = photoInput.cloneNode(true);
                    
                    // Try to set its files property if possible (may not work in all browsers)
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    newInput.files = dt.files;
                    
                    // Replace the old input with the new one
                    photoInput.parentNode.replaceChild(newInput, photoInput);
                    
                    // Update our reference to the input
                    photoInput = document.getElementById('incident_photo');
                    
                    // Attach event listener to the new input
                    photoInput.addEventListener('change', function() {
                        handleImagePreview(this);
                    });
                } catch (e) {
                    console.log("Browser doesn't support direct file manipulation:", e);
                    // For these browsers, we'll rely on the preview image and the form will use the camera input
                    // Rename the camera input to match the expected name
                    cameraInput.name = "incident_photo";
                }
            }
        });
    }
    
    // Handle capture button click
    if (captureBtn) {
        captureBtn.addEventListener('click', function() {
            // Trigger the camera input
            if (cameraInput) {
                cameraInput.click();
            }
        });
    }
    
    // Handle remove photo button
    if (removePhotoBtn) {
        removePhotoBtn.addEventListener('click', function() {
            photoInput.value = '';
            if (cameraInput) cameraInput.value = '';
            previewContainer.classList.add('d-none');
            previewImage.src = '';
        });
    }
});

// Function to generate a unique report number based on date
function generateReportNumber() {
    const dateInput = document.getElementById('incident_date');
    const reportNumberField = document.getElementById('report_number');
    
    if (dateInput && reportNumberField) {
        const selectedDate = new Date(dateInput.value);
        // Use 2-digit year and 1-letter month code (A-L for Jan-Dec)
        const year = selectedDate.getFullYear().toString().slice(-2);
        const monthCode = "ABCDEFGHIJKL".charAt(selectedDate.getMonth());
        const day = String(selectedDate.getDate()).padStart(2, '0');
        
        // Extract department code (first letter) and last 2 digits of staff ID
        const departmentCode = "{{ staff.department.name|slice:":1"|upper }}";
        const staffId = "{{ staff.id }}".slice(-2).padStart(2, '0');
        
        // Get or initialize a counter from sessionStorage
        let counterKey = `IR_${year}${monthCode}${day}_${staffId}`;
        let reportCounter = 1;
        
        if (sessionStorage.getItem(counterKey)) {
            reportCounter = parseInt(sessionStorage.getItem(counterKey)) + 1;
        }
        
        // Store the updated counter
        sessionStorage.setItem(counterKey, reportCounter);
        
        // Format the serial number
        const serialNumber = String(reportCounter).padStart(2, '0');
        
        // Create the shortest practical incident report number: IRYYMD-CSS
        // Example: IR23A05-H42 (2023 Jan 5, HR dept, staff ID 42)
        const reportNumber = `IR${year}${monthCode}${day}-${departmentCode}${staffId}${serialNumber}`;
        
        // Set the report number field value
        reportNumberField.value = reportNumber;
        
        // Also store this report number in sessionStorage to track it
        let generatedReports = JSON.parse(sessionStorage.getItem('GENERATED_INCIDENT_REPORTS') || '[]');
        generatedReports.push(reportNumber);
        sessionStorage.setItem('GENERATED_INCIDENT_REPORTS', JSON.stringify(generatedReports));
    }
}
</script>
{% endblock %} 