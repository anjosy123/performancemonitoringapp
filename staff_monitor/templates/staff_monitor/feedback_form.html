<!-- staff_monitor/templates/staff_monitor/feedback_form.html -->
{% extends 'staff_monitor/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="card mb-4 form-card main-card">
        <div class="card-header bg-danger text-white py-3">
            <h2 class="text-center mb-0">MARIAMPUR HOSPITAL</h2>
            <h4 class="text-center mb-0">STAFF INCIDENT REPORT FORM</h4>
        </div>
        
        <div class="card-body p-4">
            <form method="post" class="needs-validation" novalidate id="incidentForm">
                {% csrf_token %}
                
                <!-- Staff Information Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-user-tie me-2 text-danger"></i>
                            <span>Staff Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="40%">Name:</th>
                                        <td>{{ staff.user.get_full_name }}</td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Designation:</th>
                                        <td>{{ staff.position }}</td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Employee ID:</th>
                                        <td>{{ staff.employee_id }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="40%">Department:</th>
                                        <td>{{ staff.department }}</td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Date of Joining:</th>
                                        <td>{{ staff.joining_date }}</td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">Date of Appointment:</th>
                                        <td>{{ staff.appointment_date|default:"-" }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Incident Information Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-info-circle me-2 text-danger"></i>
                            <span>Incident Information</span>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">DATE OF INCIDENT:</label>
                                <input type="date" name="incident_date" id="incident_date" class="form-control form-input" required
                                    max="{{ today|date:'Y-m-d' }}"
                                    value="{{ today|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">TIME:</label>
                                <input type="time" name="incident_time" class="form-control form-input" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">LOCATION:</label>
                                <input type="text" name="incident_location" class="form-control form-input" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">INCIDENT REPORT NO.:</label>
                                <input type="text" name="report_number" id="report_number" class="form-control form-input bg-light fw-bold" 
                                    readonly style="border: 2px solid #dc3545; color: #dc3545;">
                                <small class="form-text text-muted">(Auto generated unique identifier)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nature of Incident Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                            <span>Nature of incident</span>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="negligence" id="negligence">
                                    <label class="form-check-label" for="negligence">
                                        1. Negligence
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="rude_behavior" id="rudeBehavior">
                                    <label class="form-check-label" for="rudeBehavior">
                                        2. Rude behavior / Attitude
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="communication_error" id="communicationError">
                                    <label class="form-check-label" for="communicationError">
                                        3. Communication error / issue
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="documentation_issue" id="documentationIssue">
                                    <label class="form-check-label" for="documentationIssue">
                                        4. Documentation issue / error
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="reporting_error" id="reportingError">
                                    <label class="form-check-label" for="reportingError">
                                        5. Reporting error / issue
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="medication_error" id="medicationError">
                                    <label class="form-check-label" for="medicationError">
                                        6. Medication error
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="assault" id="assault">
                                    <label class="form-check-label" for="assault">
                                        7. Assault
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="policy_violation" id="policyViolation">
                                    <label class="form-check-label" for="policyViolation">
                                        8. Policy violation
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="collaborative_work_issue" id="collaborativeWorkIssue">
                                    <label class="form-check-label" for="collaborativeWorkIssue">
                                        9. Collaborative work issue / Error
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="procedure_failure" id="procedureFailure">
                                    <label class="form-check-label" for="procedureFailure">
                                        10. Failure to carry out procedure well
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input incident-type" type="checkbox" name="incident_type" 
                                        value="other" id="otherIncident">
                                    <label class="form-check-label" for="otherIncident">
                                        11. Others (Specify)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3 other-incident-details" style="display: none;">
                            <div class="col-md-12">
                                <input type="text" name="other_incident_type" class="form-control form-input" 
                                    placeholder="Please specify the incident type">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related To Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-link me-2 text-danger"></i>
                            <span>Related to</span>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="colleagues" id="colleagues">
                                    <label class="form-check-label" for="colleagues">
                                        1. Colleagues
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="patients" id="patients">
                                    <label class="form-check-label" for="patients">
                                        2. Patients
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="attender" id="attender">
                                    <label class="form-check-label" for="attender">
                                        3. Attender
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="doctors" id="doctors">
                                    <label class="form-check-label" for="doctors">
                                        4. Doctors
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input related-party" type="checkbox" name="related_party" 
                                        value="policies" id="policies">
                                    <label class="form-check-label" for="policies">
                                        5. Policies / Procedures
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Individuals Involved Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-users me-2 text-danger"></i>
                                <span>Individuals involved</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger add-individual-btn">
                                <i class="fas fa-plus me-1"></i>Add Individual
                            </button>
                        </div>
                        
                        <div id="individuals-container">
                            <!-- Template row for individuals involved -->
                            <div class="individual-row row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">1. Name of Employee('s)</label>
                                    <input type="text" name="individual_name[]" class="form-control form-input">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">2. Department</label>
                                    <input type="text" name="individual_department[]" class="form-control form-input">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">3. Position of Employee</label>
                                    <input type="text" name="individual_position[]" class="form-control form-input">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">4. Role in Incident</label>
                                    <input type="text" name="individual_role[]" class="form-control form-input">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label text-white d-block">Remove</label>
                                    <button type="button" class="btn btn-outline-secondary remove-individual-btn" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Taken Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-tasks me-2 text-danger"></i>
                            <span>Action taken</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input action-taken" type="checkbox" name="action_type" 
                                        value="immediate_action" id="immediateAction">
                                    <label class="form-check-label" for="immediateAction">
                                        1. Immediate action taken
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input action-taken" type="checkbox" name="action_type" 
                                        value="follow_up_action" id="followUpAction">
                                    <label class="form-check-label" for="followUpAction">
                                        2. Follow-up Action Taken
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conditional fields that appear when specific actions are selected -->
                        <div class="row mt-3 immediate-action-details action-detail-box" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <textarea name="immediate_action_details" class="form-control form-input" rows="3" 
                                        placeholder="Describe immediate action taken"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mt-3 follow-up-action-details action-detail-box" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <textarea name="follow_up_action_details" class="form-control form-input" rows="3" 
                                        placeholder="Describe follow-up action taken"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Preparer Section -->
                <div class="card form-section-card mb-4">
                    <div class="card-body">
                        <div class="section-title mb-3">
                            <i class="fas fa-user-edit me-2 text-danger"></i>
                            <span>Report Preparation</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Report Prepared by:</label>
                                <input type="text" name="prepared_by" class="form-control form-input bg-light" 
                                    value="{{ request.user.get_full_name }}" readonly>
                                <small class="text-muted">Auto-populated with your name</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Position/Role:</label>
                                <input type="text" name="reporter_position" class="form-control form-input bg-light" 
                                    value="{% if request.user.is_staff %}HR Director{% else %}{% if department_head %}Department Head - {{ department_head.department.name }}{% else %}{{ staff.position }}{% endif %}{% endif %}" readonly>
                                <small class="text-muted">Auto-populated with your role in the organization</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="fas fa-save me-2"></i>Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.card-header {
    background-color: #dc3545 !important;
}

.main-card {
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.form-section-card {
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}

.form-section-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.form-input {
    border-radius: 0.5rem;
    border: 1px solid #ced4da;
    padding: 0.625rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

.form-check-input:checked {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
}

.btn-outline-secondary {
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    transform: translateY(-2px);
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
    transition: all 0.3s ease;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
    transform: translateY(-1px);
}

.fw-bold {
    font-weight: bold;
}

.fw-semibold {
    font-weight: 600;
}

.action-detail-box {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.5rem;
    border-left: 3px solid #dc3545;
}

.custom-checkbox .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.15rem;
}

.custom-checkbox .form-check-label {
    padding-left: 0.25rem;
}

.table-bordered th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.table-bordered td, .table-bordered th {
    padding: 0.75rem;
}

.individual-row {
    animation: fadeIn 0.3s ease-in-out;
    position: relative;
    padding: 0.75rem;
    border-radius: 0.5rem;
}

.individual-row:not(:last-child) {
    border-bottom: 1px dashed #dee2e6;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
}

.individual-row:nth-child(even) {
    background-color: rgba(0,0,0,0.01);
}

.remove-individual-btn {
    border-radius: 50%;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-individual-btn {
    border-radius: 0.5rem;
    font-weight: 500;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the report number on page load
    generateReportNumber();
    
    // Re-generate report number when date changes
    document.getElementById('incident_date').addEventListener('change', generateReportNumber);
    
    // Show/hide other incident type details
    document.getElementById('otherIncident').addEventListener('change', function() {
        const otherIncidentDetails = document.querySelector('.other-incident-details');
        otherIncidentDetails.style.display = this.checked ? 'flex' : 'none';
    });
    
    // Show/hide immediate action details
    document.getElementById('immediateAction').addEventListener('change', function() {
        const immediateActionDetails = document.querySelector('.immediate-action-details');
        immediateActionDetails.style.display = this.checked ? 'flex' : 'none';
    });
    
    // Show/hide follow-up action details
    document.getElementById('followUpAction').addEventListener('change', function() {
        const followUpActionDetails = document.querySelector('.follow-up-action-details');
        followUpActionDetails.style.display = this.checked ? 'flex' : 'none';
    });

    // Add subtle animation to checkboxes
    const checkboxes = document.querySelectorAll('.form-check-input');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                this.closest('.form-check').classList.add('checkbox-active');
            } else {
                this.closest('.form-check').classList.remove('checkbox-active');
            }
        });
    });
    
    // Individual rows functionality
    const individualsContainer = document.getElementById('individuals-container');
    const addIndividualBtn = document.querySelector('.add-individual-btn');
    
    // Function to add a new individual row
    addIndividualBtn.addEventListener('click', function() {
        // Get all existing rows
        const existingRows = document.querySelectorAll('.individual-row');
        
        // Enable remove button on the first row if it was disabled
        if (existingRows.length === 1) {
            existingRows[0].querySelector('.remove-individual-btn').disabled = false;
        }
        
        // Clone the first row
        const newRow = existingRows[0].cloneNode(true);
        
        // Clear input values
        newRow.querySelectorAll('input').forEach(input => {
            input.value = '';
        });
        
        // Enable remove button
        const removeBtn = newRow.querySelector('.remove-individual-btn');
        removeBtn.disabled = false;
        
        // Add event listener to remove button
        removeBtn.addEventListener('click', function() {
            removeIndividualRow(this);
        });
        
        // Append the new row
        individualsContainer.appendChild(newRow);
        
        // Update numbering
        updateIndividualRowNumbers();
    });
    
    // Function to remove an individual row
    function removeIndividualRow(button) {
        const row = button.closest('.individual-row');
        row.style.opacity = '0';
        row.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
            row.remove();
            
            // If only one row remains, disable its remove button
            const remainingRows = document.querySelectorAll('.individual-row');
            if (remainingRows.length === 1) {
                remainingRows[0].querySelector('.remove-individual-btn').disabled = true;
            }
            
            // Update numbering
            updateIndividualRowNumbers();
        }, 300);
    }
    
    // Add event listener to existing remove buttons
    document.querySelectorAll('.remove-individual-btn').forEach(button => {
        button.addEventListener('click', function() {
            removeIndividualRow(this);
        });
    });
    
    // Function to update row numbers
    function updateIndividualRowNumbers() {
        const rows = document.querySelectorAll('.individual-row');
        rows.forEach((row, index) => {
            const rowNumber = index + 1;
            row.dataset.rowNumber = rowNumber;
        });
    }

    // Form validation and submission
    const form = document.getElementById('incidentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Always prevent default form submission first
            
            // Check required fields
            const requiredInputs = form.querySelectorAll('input[required]');
            let allFilled = true;
            
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    allFilled = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            // Check if at least one incident type is selected
            const incidentTypes = form.querySelectorAll('input[name="incident_type"]:checked');
            if (incidentTypes.length === 0) {
                allFilled = false;
                Swal.fire({
                    title: 'Incomplete Form',
                    text: 'Please select at least one incident type.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }

            if (!allFilled) {
                Swal.fire({
                    title: 'Incomplete Form',
                    text: 'Please fill in all required fields before submitting.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            // All validations passed, show confirmation dialog
            Swal.fire({
                title: 'Confirm Submission',
                html: `
                    <div class="text-start">
                        <p>Are you sure you want to submit this incident report for:</p>
                        <p><strong>Staff:</strong> {{ staff.user.get_full_name }}</p>
                        <p><strong>Incident Date:</strong> ${document.getElementById('incident_date').value}</p>
                        <p><strong>Report Number:</strong> ${document.getElementById('report_number').value}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Submit',
                cancelButtonText: 'No, Review',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading state
                    Swal.fire({
                        title: 'Submitting...',
                        text: 'Please wait while we process your report.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Submit the form
                    form.submit();
                }
            });
        });
    }
});

// Function to generate a unique report number based on date
function generateReportNumber() {
    const dateInput = document.getElementById('incident_date');
    const reportNumberField = document.getElementById('report_number');
    
    if (dateInput && reportNumberField) {
        const selectedDate = new Date(dateInput.value);
        // Use 2-digit year and 1-letter month code (A-L for Jan-Dec)
        const year = selectedDate.getFullYear().toString().slice(-2);
        const monthCode = "ABCDEFGHIJKL".charAt(selectedDate.getMonth());
        const day = String(selectedDate.getDate()).padStart(2, '0');
        
        // Extract department code (first letter) and last 2 digits of staff ID
        const departmentCode = "{{ staff.department.name|slice:":1"|upper }}";
        const staffId = "{{ staff.id }}".slice(-2).padStart(2, '0');
        
        // Get or initialize a counter from sessionStorage
        let counterKey = `IR_${year}${monthCode}${day}_${staffId}`;
        let reportCounter = 1;
        
        if (sessionStorage.getItem(counterKey)) {
            reportCounter = parseInt(sessionStorage.getItem(counterKey)) + 1;
        }
        
        // Store the updated counter
        sessionStorage.setItem(counterKey, reportCounter);
        
        // Format the serial number
        const serialNumber = String(reportCounter).padStart(2, '0');
        
        // Create the shortest practical incident report number: IRYYMD-CSS
        // Example: IR23A05-H42 (2023 Jan 5, HR dept, staff ID 42)
        const reportNumber = `IR${year}${monthCode}${day}-${departmentCode}${staffId}${serialNumber}`;
        
        // Set the report number field value
        reportNumberField.value = reportNumber;
        
        // Also store this report number in sessionStorage to track it
        let generatedReports = JSON.parse(sessionStorage.getItem('GENERATED_INCIDENT_REPORTS') || '[]');
        generatedReports.push(reportNumber);
        sessionStorage.setItem('GENERATED_INCIDENT_REPORTS', JSON.stringify(generatedReports));
    }
}
</script>
{% endblock %} 